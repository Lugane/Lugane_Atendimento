<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lugane Atendimento</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      padding: 20px;
    }

    h1, h2 {
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #d8773f;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #cc6123;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      height: 120px;
    }

    .header img {
      position: absolute;
      left: 0;
      height: 100%;
      width: auto;
      padding-left: 10px;
    }

    .header h1 {
      margin: 0;
      font-size: 1.5rem;
      text-align: center;
      font-style: italic;
    }

    #form-atendimento, table, h2 {
      display: none;
    }

    #tela-login {
      width: 400px;
      height: 500px;
      margin: auto;
      text-align: center;
      justify-content: center;
      margin-top: 100px;
    }
  </style>
</head>

<body>
  <div class="header">
    <img src="/logo_semfundo.png" alt="">
    <h1>Lugane Atendimento:</h1>
  </div>

  <div id="tela-login">
    <h2>Digite a senha para acessar:</h2>
    <input type="password" id="senhaLogin" placeholder="Senha de acesso">
    <button onclick="verificarSenha()">Entrar</button>
  </div>

  <div id="form-atendimento">
    <h2>Registrar Atendimento</h2>

    <div class="form-group">
      <label for="nomeAtend">Nome</label>
      <input type="text" id="nomeAtend" placeholder="Nome">
    </div>

    <div class="form-group">
      <label for="descricaoAtend">Descrição</label>
      <input type="text" id="descricaoAtend" placeholder="Descrição">
    </div>

    <div class="form-group">
      <label for="dataAtend">Data</label>
      <input type="date" id="dataAtend">
    </div>

    <div class="form-group">
      <label for="empresaAtend">Empresa Atendida</label>
      <input type="text" id="empresaAtend" placeholder="Empresa Atendida">
    </div>

    <button onclick="salvarAtendimento()">Salvar Atendimento</button>
  </div>

  <h2>Lista de Atendimentos</h2>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Descrição</th>
        <th>Data</th>
        <th>Empresa</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabela-atendimentos"></tbody>
  </table>

  <script>
    const API_URL = "http://localhost:3000/api/atendimentos";

    async function salvarAtendimento() {
      const nome = document.getElementById('nomeAtend').value.trim();
      const descricao = document.getElementById('descricaoAtend').value.trim();
      const data = document.getElementById('dataAtend').value; // já vem como string "YYYY-MM-DD"
      const empresa = document.getElementById('empresaAtend').value.trim();

      if (!nome || !descricao || !data || !empresa) {
        alert("Preencha todos os campos do atendimento.");
        return;
      }

      const atendimento = { nome, descricao, data, empresa };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(atendimento)
        });

        if (res.ok) {
          alert("Atendimento salvo com sucesso!");
          limparFormulario();
          carregarAtendimentos();
        } else {
          const erro = await res.json();
          alert("Erro ao salvar: " + (erro.error || 'Desconhecido'));
        }
      } catch (error) {
        alert("Erro de conexão: " + error.message);
      }
    }

    function limparFormulario() {
      document.getElementById('nomeAtend').value = '';
      document.getElementById('descricaoAtend').value = '';
      document.getElementById('dataAtend').value = '';
      document.getElementById('empresaAtend').value = '';
    }

    async function carregarAtendimentos() {
      try {
        const res = await fetch(API_URL);
        const dados = await res.json();

        const tbody = document.getElementById('tabela-atendimentos');
        tbody.innerHTML = '';

        dados.forEach(item => {
          const id = item.id || item._id;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.nome}</td>
            <td>${item.descricao}</td>
            <td>${formatarData(item.data)}</td>
            <td>${item.empresa}</td>
            <td><button onclick="deletarAtendimento('${id}')">Excluir</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error("Erro ao carregar atendimentos:", error.message);
      }
    }

    // ✅ Formata corretamente a data no formato brasileiro
    function formatarData(dataString) {
      const [ano, mes, dia] = dataString.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    async function deletarAtendimento(id) {
      if (!confirm("Tem certeza que deseja excluir este atendimento?")) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert("Atendimento excluído com sucesso.");
          carregarAtendimentos();
        } else {
          let erroTexto = await res.text();
          try {
            const erro = JSON.parse(erroTexto);
            alert("Erro ao excluir: " + (erro.error || 'Desconhecido'));
          } catch {
            alert("Erro ao excluir (resposta inesperada): " + erroTexto);
          }
        }
      } catch (error) {
        alert("Erro de conexão: " + error.message);
      }
    }

    // Carrega os dados assim que a página abrir
    carregarAtendimentos();

    const SENHA_PADRAO = "Lvr1939";

    function verificarSenha() {
      const senha = document.getElementById("senhaLogin").value;
      if (senha === SENHA_PADRAO) {
        document.getElementById("tela-login").style.display = "none";
        document.getElementById("form-atendimento").style.display = "block";
        document.querySelector("table").style.display = "table";
        document.querySelector("h2:nth-of-type(2)").style.display = "block";
        carregarAtendimentos();
      } else {
        alert("Senha incorreta!");
      }
    }
  </script>
</body>
</html>

<!-- Deixar privado no github todos os projetos -->
<!-- Ajustar estilização -->